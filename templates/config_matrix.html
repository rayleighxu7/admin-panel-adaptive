{% extends "layout.html" %}

{% block title %}Config Matrix — Admin Panel{% endblock %}

{% block header %}
    <div class="row align-items-center">
        <div class="col">
            <h2 class="page-title">
                <i class="fa fa-link me-2"></i>Config Matrix
            </h2>
            <div class="text-muted mt-1" id="matrix-summary">Loading&hellip;</div>
        </div>
    </div>
{% endblock %}

{% block content %}
<div class="col-12">
    <div class="card matrix-card">
        <div class="card-header list-header-row">
            <div class="col list-toolbar">
                <div class="searchable-filter filter-control">
                    <input
                        type="text"
                        class="form-control"
                        id="filter-customer"
                        placeholder="All Customers (type to search)"
                        autocomplete="off"
                    >
                    <div class="searchable-filter-menu d-none" id="filter-customer-menu"></div>
                </div>
                <div class="searchable-filter filter-control">
                    <input
                        type="text"
                        class="form-control"
                        id="filter-config-type-search"
                        placeholder="All Config Types"
                        autocomplete="off"
                    >
                    <div class="searchable-filter-menu d-none" id="filter-config-type-menu"></div>
                </div>
                <input type="hidden" id="filter-config-type" value="">
                <div class="searchable-filter filter-control">
                    <input
                        type="text"
                        class="form-control"
                        id="filter-config"
                        placeholder="All Configs (type to search)"
                        autocomplete="off"
                    >
                    <div class="searchable-filter-menu d-none" id="filter-config-menu"></div>
                </div>
            </div>
            <div class="col-auto ms-auto ps-2 list-toolbar-actions">
                <button class="btn btn-primary" data-bs-toggle="offcanvas" data-bs-target="#matrix-drawer" onclick="openCreate()">
                    <i class="fa fa-plus me-1"></i>Assign Config
                </button>
            </div>
        </div>
        <div class="table-responsive">
            <table class="table table-vcenter table-hover card-table table-modern">
                <thead>
                    <tr>
                        <th>Customer</th>
                        <th>Config Type</th>
                        <th>Config</th>
                        <th>Effective From</th>
                        <th>Created</th>
                        <th class="w-1"></th>
                    </tr>
                </thead>
                <tbody id="matrix-tbody">
                    <tr>
                        <td colspan="6" class="text-center text-muted py-4">
                            <i class="fa fa-spinner fa-spin me-1"></i> Loading&hellip;
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        <div class="card-footer d-flex align-items-center">
            <div class="text-muted" id="pagination-info"></div>
            <div class="ms-auto btn-group" id="pagination-btns"></div>
        </div>
    </div>
</div>

<div class="offcanvas offcanvas-end drawer-lg" tabindex="-1" id="matrix-drawer">
    <div class="offcanvas-header">
        <h5 class="offcanvas-title" id="drawer-title">Assign Config</h5>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
    </div>
    <div class="offcanvas-body">
        <div id="drawer-error" class="alert alert-danger d-none"></div>
        <input type="hidden" id="edit-id">
        <div class="mb-3" id="customer-field">
            <label class="form-label">Customer</label>
            <div class="searchable-filter">
                <input
                    type="text"
                    class="form-control"
                    id="input-customer-search"
                    placeholder="Select customer (type to search)"
                    autocomplete="off"
                >
                <div class="searchable-filter-menu d-none" id="input-customer-menu"></div>
            </div>
            <input type="hidden" id="input-customer" required>
        </div>
        <div class="mb-3">
            <label class="form-label">Config Type</label>
            <div class="searchable-filter">
                <input
                    type="text"
                    class="form-control"
                    id="input-config-type-search"
                    placeholder="Select config type"
                    autocomplete="off"
                >
                <div class="searchable-filter-menu d-none" id="input-config-type-menu"></div>
            </div>
            <input type="hidden" id="input-config-type" value="preset">
        </div>
        <div class="mb-3" id="preset-field">
            <label class="form-label">Preset Config</label>
            <div class="searchable-filter">
                <input
                    type="text"
                    class="form-control"
                    id="input-preset-search"
                    placeholder="Select preset (type to search)"
                    autocomplete="off"
                >
                <div class="searchable-filter-menu d-none" id="input-preset-menu"></div>
            </div>
            <input type="hidden" id="input-preset">
        </div>
        <div class="mb-3">
            <label class="form-label">Effective From</label>
            <input type="date" class="form-control" id="input-effective-from" required>
        </div>
        <hr class="my-3">
        <div class="form-section-title">Config Values</div>
        <div class="row mb-3">
            <div class="col-6">
                <label class="form-label">Commission %</label>
                <input type="number" step="0.01" class="form-control" id="cfg-commission" value="0">
            </div>
            <div class="col-6">
                <label class="form-label">Affiliate %</label>
                <input type="number" step="0.01" class="form-control" id="cfg-affiliate" value="0">
            </div>
        </div>
        <div class="mb-3">
            <label class="form-label">GMV %</label>
            <input type="number" step="0.01" class="form-control" id="cfg-gmv" value="0">
        </div>
        <div class="row mb-3">
            <div class="col-6">
                <label class="form-label">Per Order Fee ($)</label>
                <input type="number" step="0.01" class="form-control" id="cfg-per-order-fee" value="0">
            </div>
            <div class="col-6">
                <label class="form-label">Qty Threshold</label>
                <input type="number" class="form-control" id="cfg-per-order-threshold" value="0">
            </div>
        </div>
        <div class="mb-3">
            <label class="form-label">Flat Fee ($)</label>
            <input type="number" step="0.01" class="form-control" id="cfg-flat-fee" value="0">
        </div>
    </div>
    <div class="offcanvas-footer p-3 border-top d-flex">
        <button type="button" class="btn me-auto" data-bs-dismiss="offcanvas">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="saveMatrix()">Save</button>
    </div>
</div>
{% endblock %}

{% block script %}
<script>
(function() {
    const API = '/api/config-matrix';
    const tbody = document.getElementById('matrix-tbody');
    const summary = document.getElementById('matrix-summary');
    const filterCustomer = document.getElementById('filter-customer');
    const filterCustomerMenu = document.getElementById('filter-customer-menu');
    const filterConfigType = document.getElementById('filter-config-type');
    const filterConfigTypeSearch = document.getElementById('filter-config-type-search');
    const filterConfigTypeMenu = document.getElementById('filter-config-type-menu');
    const filterConfig = document.getElementById('filter-config');
    const filterConfigMenu = document.getElementById('filter-config-menu');
    const paginationInfo = document.getElementById('pagination-info');
    const paginationBtns = document.getElementById('pagination-btns');
    const configTypeSelect = document.getElementById('input-config-type');
    const drawerConfigTypeSearch = document.getElementById('input-config-type-search');
    const drawerConfigTypeMenu = document.getElementById('input-config-type-menu');
    const presetField = document.getElementById('preset-field');
    const drawerCustomerSearch = document.getElementById('input-customer-search');
    const drawerCustomerMenu = document.getElementById('input-customer-menu');
    const drawerCustomerInput = document.getElementById('input-customer');
    const drawerPresetSearch = document.getElementById('input-preset-search');
    const drawerPresetMenu = document.getElementById('input-preset-menu');
    const presetSelect = document.getElementById('input-preset');
    const cfgFields = ['cfg-commission', 'cfg-affiliate', 'cfg-gmv', 'cfg-per-order-fee', 'cfg-per-order-threshold', 'cfg-flat-fee'];

    let currentOffset = 0;
    const LIMIT = 25;
    let customersCache = [];
    let presetsCache = [];
    const customConfigMap = new Map();
    let customerFilterOptions = [];
    let configFilterOptions = [];
    let drawerCustomerOptions = [];
    let drawerPresetOptions = [];
    const headerConfigTypeOptions = [
        { key: '', label: 'All Config Types', subtext: '' },
        { key: 'preset', label: 'Preset', subtext: '' },
        { key: 'custom', label: 'Custom', subtext: '' },
    ];
    const drawerConfigTypeOptions = [
        { key: 'preset', label: 'Preset Config', subtext: '' },
        { key: 'custom', label: 'Custom Config', subtext: '' },
    ];
    let selectedCustomerFilter = '';
    let selectedConfigFilter = '';

    function esc(str) {
        const d = document.createElement('div');
        d.textContent = String(str);
        return d.innerHTML;
    }

    function formatDate(iso) {
        return new Date(iso).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
    }

    function setConfigFields(config, disabled) {
        document.getElementById('cfg-commission').value = (config.commission_percentage * 100).toFixed(2);
        document.getElementById('cfg-affiliate').value = (config.affiliate_percentage * 100).toFixed(2);
        document.getElementById('cfg-gmv').value = (config.gmv_percentage * 100).toFixed(2);
        document.getElementById('cfg-per-order-fee').value = (config.per_order.fee_cents / 100).toFixed(2);
        document.getElementById('cfg-per-order-threshold').value = config.per_order.quantity_threshold;
        document.getElementById('cfg-flat-fee').value = (config.flat_fee_cents / 100).toFixed(2);
        cfgFields.forEach(id => {
            const el = document.getElementById(id);
            el.disabled = disabled;
        });
    }

    function clearConfigFields(disabled) {
        setConfigFields({
            commission_percentage: 0, affiliate_percentage: 0, gmv_percentage: 0,
            per_order: { fee_cents: 0, quantity_threshold: 0 }, flat_fee_cents: 0,
        }, disabled);
    }

    function getConfigFromForm() {
        return {
            commission_percentage: (parseFloat(document.getElementById('cfg-commission').value) || 0) / 100,
            affiliate_percentage: (parseFloat(document.getElementById('cfg-affiliate').value) || 0) / 100,
            gmv_percentage: (parseFloat(document.getElementById('cfg-gmv').value) || 0) / 100,
            per_order: {
                fee_cents: Math.round((parseFloat(document.getElementById('cfg-per-order-fee').value) || 0) * 100),
                quantity_threshold: parseInt(document.getElementById('cfg-per-order-threshold').value) || 0,
            },
            flat_fee_cents: Math.round((parseFloat(document.getElementById('cfg-flat-fee').value) || 0) * 100),
        };
    }

    function updateConfigTypeUI() {
        const isPreset = configTypeSelect.value === 'preset';
        presetField.classList.toggle('d-none', !isPreset);
        if (isPreset) {
            const presetId = presetSelect.value;
            const preset = presetsCache.find(p => p.id == presetId);
            if (preset) {
                setConfigFields(preset.config, true);
            } else {
                clearConfigFields(true);
            }
        } else {
            cfgFields.forEach(id => {
                const el = document.getElementById(id);
                el.disabled = false;
            });
        }
    }

    configTypeSelect.addEventListener('change', updateConfigTypeUI);

    presetSelect.addEventListener('change', function() {
        if (configTypeSelect.value === 'preset') {
            const preset = presetsCache.find(p => p.id == this.value);
            if (preset) {
                setConfigFields(preset.config, true);
            } else {
                clearConfigFields(true);
            }
        }
    });

    function loadLookups() {
        Promise.all([
            fetch('/api/customers?limit=200').then(r => r.json()),
            fetch('/api/preset-configs?limit=200').then(r => r.json()),
        ]).then(([custData, presetData]) => {
            customersCache = custData.customers;
            presetsCache = presetData.preset_configs;
            populateSelects();
        });
    }

    function populateSelects() {
        customerFilterOptions = customersCache.map(c => ({
            id: c.id,
            label: c.name,
            subtext: c.id,
        }));
        drawerCustomerOptions = customerFilterOptions.map(c => ({
            key: c.id,
            label: c.label,
            subtext: c.subtext,
        }));
        syncSelectedFilterInput('customer');

        drawerPresetOptions = presetsCache.map(p => ({
            key: String(p.id),
            label: p.name,
            subtext: `Preset #${p.id}`,
        }));
        populateConfigFilterOptions();
        syncDrawerSelectionInput('customer');
        syncDrawerSelectionInput('preset');
    }

    function syncCustomConfigOptions(rows) {
        rows.forEach(m => {
            if (m.custom_config_id) {
                const id = String(m.custom_config_id);
                if (!customConfigMap.has(id)) {
                    customConfigMap.set(id, `Custom #${id}`);
                }
            }
        });
    }

    function populateConfigFilterOptions() {
        const type = filterConfigType.value;
        configFilterOptions = [];

        if (!type || type === 'preset') {
            configFilterOptions.push(
                ...presetsCache.map(p => ({
                    value: `preset:${p.id}`,
                    label: p.name,
                    subtext: `Preset #${p.id}`,
                }))
            );
        }

        if (!type || type === 'custom') {
            configFilterOptions.push(
                ...Array.from(customConfigMap.entries())
                .sort((a, b) => Number(a[0]) - Number(b[0]))
                .map(([id, name]) => ({
                    value: `custom:${id}`,
                    label: name,
                    subtext: `Custom #${id}`,
                }))
            );
        }

        if (selectedConfigFilter && !configFilterOptions.some(o => o.value === selectedConfigFilter)) {
            selectedConfigFilter = '';
        }
        syncSelectedFilterInput('config');
    }

    function filteredOptions(options, query) {
        const q = query.trim().toLowerCase();
        if (!q) return options;
        return options.filter(o =>
            String(o.label).toLowerCase().includes(q) ||
            String(o.subtext || '').toLowerCase().includes(q)
        );
    }

    function renderSearchableMenu(menuEl, options, keyName) {
        if (!options.length) {
            menuEl.innerHTML = '<div class="searchable-filter-empty">No matches</div>';
            menuEl.dataset.options = '[]';
            return;
        }

        menuEl.dataset.options = JSON.stringify(options.map(o => ({ key: o[keyName], label: o.label, subtext: o.subtext || '' })));
        menuEl.innerHTML = options.map((o, idx) => `
            <button type="button" class="searchable-filter-option" data-index="${idx}">
                <span class="searchable-filter-option-main">${esc(o.label)}</span>
                ${o.subtext ? `<span class="searchable-filter-option-sub">${esc(o.subtext)}</span>` : ''}
            </button>
        `).join('');
    }

    function applyTableFilters() {
        currentOffset = 0;
        loadMatrix();
    }

    function syncSelectedFilterInput(kind) {
        if (kind === 'customer') {
            const selected = customerFilterOptions.find(o => o.id === selectedCustomerFilter);
            filterCustomer.value = selected ? selected.label : '';
            return;
        }
        const selected = configFilterOptions.find(o => o.value === selectedConfigFilter);
        filterConfig.value = selected ? selected.label : '';
    }

    function bindSearchableFilter(inputEl, menuEl, getOptions, keyName, onPick, onClear) {
        const wrapperEl = inputEl.closest('.searchable-filter');

        function closeAllSearchableMenus() {
            document.querySelectorAll('.searchable-filter-menu').forEach(function(menu) {
                if (menu !== menuEl) menu.classList.add('d-none');
            });
            document.querySelectorAll('.searchable-filter.is-open').forEach(function(el) {
                if (el !== wrapperEl) el.classList.remove('is-open');
            });
        }

        function openMenu() {
            closeAllSearchableMenus();
            menuEl.classList.remove('d-none');
            if (wrapperEl) wrapperEl.classList.add('is-open');
        }

        function closeMenu() {
            menuEl.classList.add('d-none');
            if (wrapperEl) wrapperEl.classList.remove('is-open');
        }

        function refreshMenu() {
            const options = filteredOptions(getOptions(), inputEl.value);
            renderSearchableMenu(menuEl, options, keyName);
            openMenu();
            return options;
        }

        inputEl.addEventListener('focus', refreshMenu);
        inputEl.addEventListener('input', function() {
            if (!inputEl.value.trim()) {
                onClear();
                applyTableFilters();
            }
            refreshMenu();
        });
        inputEl.addEventListener('keydown', function(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                const options = filteredOptions(getOptions(), inputEl.value);
                if (options.length > 0) {
                    const first = options[0];
                    onPick({
                        key: first[keyName],
                        label: first.label,
                        subtext: first.subtext || '',
                    });
                } else {
                    onClear();
                    inputEl.value = '';
                    applyTableFilters();
                }
                closeMenu();
            } else if (event.key === 'Escape') {
                closeMenu();
            }
        });
        inputEl.addEventListener('blur', function() {
            setTimeout(closeMenu, 120);
        });
        menuEl.addEventListener('mousedown', function(event) {
            event.preventDefault();
        });
        menuEl.addEventListener('click', function(event) {
            const button = event.target.closest('.searchable-filter-option');
            if (!button) return;
            const options = JSON.parse(menuEl.dataset.options || '[]');
            const pick = options[Number(button.dataset.index)];
            if (!pick) return;
            onPick(pick);
            closeMenu();
        });
    }

    function syncDrawerSelectionInput(kind) {
        if (kind === 'customer') {
            const selected = drawerCustomerOptions.find(o => o.key === drawerCustomerInput.value);
            drawerCustomerSearch.value = selected ? selected.label : '';
            return;
        }
        if (kind === 'preset') {
            const selected = drawerPresetOptions.find(o => o.key === String(presetSelect.value || ''));
            drawerPresetSearch.value = selected ? selected.label : '';
            return;
        }
        const selectedType = drawerConfigTypeOptions.find(o => o.key === String(configTypeSelect.value || 'preset'));
        drawerConfigTypeSearch.value = selectedType ? selectedType.label : 'Preset Config';
    }

    bindSearchableFilter(
        filterCustomer,
        filterCustomerMenu,
        () => customerFilterOptions,
        'id',
        function(pick) {
            selectedCustomerFilter = pick.key;
            filterCustomer.value = pick.label;
            applyTableFilters();
        },
        function() {
            selectedCustomerFilter = '';
        }
    );

    bindSearchableFilter(
        filterConfigTypeSearch,
        filterConfigTypeMenu,
        () => headerConfigTypeOptions,
        'key',
        function(pick) {
            filterConfigType.value = pick.key;
            filterConfigTypeSearch.value = pick.label;
            filterConfigType.dispatchEvent(new Event('change'));
        },
        function() {
            filterConfigType.value = '';
            filterConfigTypeSearch.value = 'All Config Types';
            filterConfigType.dispatchEvent(new Event('change'));
        }
    );

    bindSearchableFilter(
        filterConfig,
        filterConfigMenu,
        () => configFilterOptions,
        'value',
        function(pick) {
            selectedConfigFilter = pick.key;
            filterConfig.value = pick.label;
            applyTableFilters();
        },
        function() {
            selectedConfigFilter = '';
        }
    );

    bindSearchableFilter(
        drawerConfigTypeSearch,
        drawerConfigTypeMenu,
        () => drawerConfigTypeOptions,
        'key',
        function(pick) {
            configTypeSelect.value = pick.key;
            drawerConfigTypeSearch.value = pick.label;
            configTypeSelect.dispatchEvent(new Event('change'));
        },
        function() {
            configTypeSelect.value = 'preset';
            drawerConfigTypeSearch.value = 'Preset Config';
            configTypeSelect.dispatchEvent(new Event('change'));
        }
    );

    bindSearchableFilter(
        drawerCustomerSearch,
        drawerCustomerMenu,
        () => drawerCustomerOptions,
        'key',
        function(pick) {
            drawerCustomerInput.value = pick.key;
            drawerCustomerSearch.value = pick.label;
            drawerCustomerSearch.classList.remove('is-invalid');
        },
        function() {
            drawerCustomerInput.value = '';
        }
    );

    bindSearchableFilter(
        drawerPresetSearch,
        drawerPresetMenu,
        () => drawerPresetOptions,
        'key',
        function(pick) {
            presetSelect.value = pick.key;
            drawerPresetSearch.value = pick.label;
            drawerPresetSearch.classList.remove('is-invalid');
            if (configTypeSelect.value === 'preset') {
                const preset = presetsCache.find(p => String(p.id) === String(pick.key));
                if (preset) setConfigFields(preset.config, true);
            }
        },
        function() {
            presetSelect.value = '';
        }
    );

    function loadMatrix() {
        let url = `${API}?limit=${LIMIT}&offset=${currentOffset}`;
        const configType = filterConfigType.value;
        if (selectedCustomerFilter) url += `&customer_id=${encodeURIComponent(selectedCustomerFilter)}`;
        if (configType) url += `&config_type=${encodeURIComponent(configType)}`;
        if (selectedConfigFilter) {
            const [kind, id] = selectedConfigFilter.split(':');
            if (kind === 'preset' && id) url += `&preset_config_id=${encodeURIComponent(id)}`;
            if (kind === 'custom' && id) url += `&custom_config_id=${encodeURIComponent(id)}`;
        }

        fetch(url)
            .then(r => r.json())
            .then(data => {
                syncCustomConfigOptions(data.config_matrix);
                populateConfigFilterOptions();
                summary.textContent = `${data.total} assignment${data.total !== 1 ? 's' : ''}`;
                renderTable(data.config_matrix);
                renderPagination(data.total);
            })
            .catch(err => {
                tbody.innerHTML = `<tr><td colspan="6" class="text-center text-danger py-4">Failed to load: ${esc(err.message)}</td></tr>`;
            });
    }

    function renderTable(rows) {
        if (rows.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted py-4">No config assignments found</td></tr>';
            return;
        }

        tbody.innerHTML = rows.map(m => {
            const configName = m.preset_config_name || `Custom #${m.custom_config_id}`;
            const badge = m.preset_config_id
                ? '<span class="badge bg-blue-lt">Preset</span>'
                : '<span class="badge bg-purple-lt">Custom</span>';
            const configDisplay = m.preset_config_id
                ? `<a class="config-link-btn" href="/preset-configs/${m.preset_config_id}">
                        <i class="fa fa-sliders"></i>${esc(configName)}
                   </a>`
                : `<span class="config-chip">
                        <i class="fa fa-sliders"></i>${esc(configName)}
                   </span>`;

            return `
            <tr>
                <td>
                    <a class="customer-link-btn" href="/customers/${encodeURIComponent(m.customer_id)}">
                        <i class="fa fa-user"></i>
                        ${esc(m.customer_name || m.customer_id)}
                    </a>
                    <div class="text-meta">${esc(m.customer_id)}</div>
                </td>
                <td>${badge}</td>
                <td>${configDisplay}</td>
                <td>${formatDate(m.effective_from)}</td>
                <td class="text-meta">${formatDate(m.created_at)}</td>
                <td>
                    <div class="dropdown">
                        <button class="btn btn-ghost-secondary btn-sm dropdown-toggle" data-bs-toggle="dropdown">
                            <i class="fa fa-ellipsis-v"></i>
                        </button>
                        <div class="dropdown-menu dropdown-menu-end">
                            <a class="dropdown-item" href="#" onclick="openEdit(${m.id}); return false;">
                                <i class="fa fa-pen me-2"></i>Edit
                            </a>
                            <a class="dropdown-item text-danger" href="#" onclick="deleteMatrix(${m.id}); return false;">
                                <i class="fa fa-trash me-2"></i>Delete
                            </a>
                        </div>
                    </div>
                </td>
            </tr>`;
        }).join('');
    }

    function renderPagination(total) {
        const page = Math.floor(currentOffset / LIMIT) + 1;
        const totalPages = Math.ceil(total / LIMIT) || 1;
        const from = total === 0 ? 0 : currentOffset + 1;
        const to = Math.min(currentOffset + LIMIT, total);

        paginationInfo.textContent = `Showing ${from}–${to} of ${total}`;

        let btns = '';
        if (page > 1) btns += `<button class="btn btn-sm" onclick="goToPage(${page - 1})"><i class="fa fa-chevron-left"></i></button>`;
        btns += `<button class="btn btn-sm" disabled>Page ${page} of ${totalPages}</button>`;
        if (page < totalPages) btns += `<button class="btn btn-sm" onclick="goToPage(${page + 1})"><i class="fa fa-chevron-right"></i></button>`;
        paginationBtns.innerHTML = btns;
    }

    window.goToPage = function(page) {
        currentOffset = (page - 1) * LIMIT;
        loadMatrix();
    };

    filterConfigType.addEventListener('change', function() {
        if (filterConfigType.value && selectedConfigFilter && !selectedConfigFilter.startsWith(filterConfigType.value + ':')) {
            selectedConfigFilter = '';
        }
        const selectedType = headerConfigTypeOptions.find(o => o.key === filterConfigType.value);
        filterConfigTypeSearch.value = selectedType ? selectedType.label : 'All Config Types';
        populateConfigFilterOptions();
        applyTableFilters();
    });

    window.openCreate = function() {
        document.getElementById('drawer-title').textContent = 'Assign Config';
        document.getElementById('edit-id').value = '';
        drawerCustomerInput.value = '';
        drawerCustomerSearch.value = '';
        document.getElementById('input-config-type').value = 'preset';
        syncDrawerSelectionInput('configType');
        presetSelect.value = '';
        drawerPresetSearch.value = '';
        document.getElementById('input-effective-from').value = new Date().toISOString().split('T')[0];
        document.getElementById('customer-field').style.display = '';
        document.getElementById('drawer-error').classList.add('d-none');
        clearConfigFields(true);
        updateConfigTypeUI();
    };

    window.openEdit = function(id) {
        document.getElementById('drawer-error').classList.add('d-none');
        fetch(`${API}/${id}`)
            .then(r => r.json())
            .then(data => {
                document.getElementById('drawer-title').textContent = 'Edit Assignment';
                document.getElementById('edit-id').value = data.id;
                drawerCustomerInput.value = data.customer_id;
                document.getElementById('input-effective-from').value = data.effective_from;
                document.getElementById('customer-field').style.display = '';

                if (data.preset_config_id) {
                    document.getElementById('input-config-type').value = 'preset';
                    presetSelect.value = data.preset_config_id;
                    syncDrawerSelectionInput('preset');
                } else {
                    document.getElementById('input-config-type').value = 'custom';
                    presetSelect.value = '';
                    drawerPresetSearch.value = '';
                }
                syncDrawerSelectionInput('configType');
                syncDrawerSelectionInput('customer');

                if (data.config) {
                    setConfigFields(data.config, !!data.preset_config_id);
                } else {
                    clearConfigFields(!!data.preset_config_id);
                }

                updateConfigTypeUI();
                if (data.config && !data.preset_config_id) {
                    setConfigFields(data.config, false);
                }

                bootstrap.Offcanvas.getOrCreateInstance(document.getElementById('matrix-drawer')).show();
            });
    };

    window.saveMatrix = function() {
        const editId = document.getElementById('edit-id').value;
        const customerId = document.getElementById('input-customer').value;
        const configType = document.getElementById('input-config-type').value;
        const effectiveFrom = document.getElementById('input-effective-from').value;
        const errorEl = document.getElementById('drawer-error');
        const customerField = drawerCustomerSearch;
        const presetFieldEl = drawerPresetSearch;
        const effectiveField = document.getElementById('input-effective-from');

        customerField.classList.remove('is-invalid');
        presetFieldEl.classList.remove('is-invalid');
        effectiveField.classList.remove('is-invalid');

        if (!customerId || !effectiveFrom) {
            if (!customerId) customerField.classList.add('is-invalid');
            if (!effectiveFrom) effectiveField.classList.add('is-invalid');
            errorEl.textContent = 'Customer and effective date are required';
            errorEl.classList.remove('d-none');
            return;
        }

        const body = { customer_id: customerId, effective_from: effectiveFrom };

        if (configType === 'preset') {
            const presetId = presetSelect.value;
            if (!presetId) {
                presetFieldEl.classList.add('is-invalid');
                errorEl.textContent = 'Select a preset config';
                errorEl.classList.remove('d-none');
                return;
            }
            body.preset_config_id = parseInt(presetId);
        } else {
            body.custom_config = getConfigFromForm();
        }

        const isEdit = !!editId;
        const url = isEdit ? `${API}/${editId}` : API;
        const method = isEdit ? 'PATCH' : 'POST';

        fetch(url, {
            method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body),
        })
        .then(r => {
            if (!r.ok) return r.json().then(d => { throw new Error(d.detail || 'Request failed'); });
            return r.json();
        })
        .then(() => {
            bootstrap.Offcanvas.getInstance(document.getElementById('matrix-drawer')).hide();
            loadMatrix();
        })
        .catch(err => {
            errorEl.textContent = err.message;
            errorEl.classList.remove('d-none');
        });
    };

    window.deleteMatrix = function(id) {
        if (!confirm('Are you sure you want to remove this config assignment?')) return;
        fetch(`${API}/${id}`, { method: 'DELETE' })
            .then(r => {
                if (!r.ok) throw new Error('Delete failed');
                loadMatrix();
            })
            .catch(err => alert(err.message));
    };

    drawerCustomerSearch.addEventListener('input', function() { this.classList.remove('is-invalid'); });
    drawerPresetSearch.addEventListener('input', function() { this.classList.remove('is-invalid'); });
    drawerConfigTypeSearch.addEventListener('input', function() {
        if (!this.value.trim()) {
            configTypeSelect.value = 'preset';
            syncDrawerSelectionInput('configType');
            updateConfigTypeUI();
        }
    });
    document.getElementById('input-effective-from').addEventListener('input', function() {
        this.classList.remove('is-invalid');
    });

    loadLookups();
    filterConfigTypeSearch.value = 'All Config Types';
    syncDrawerSelectionInput('configType');
    loadMatrix();
})();
</script>
{% endblock %}
